<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="vipRegChannelStatSum">
    <resultMap type="VipRegChannelStatSum" id="VipRegChannelStatSumMap">
        <result property="channelId" column="channel_id"/>
        <result property="channelName" column="channel_name"/>
        <result property="pvCnt" column="pv_cnt"/>
        <result property="uvCnt" column="uv_cnt"/>
        <result property="ipCnt" column="ip_cnt"/>
        <result property="regUCnt" column="reg_ucnt"/>
        <result property="payUCnt" column="pay_ucnt"/>
        <result property="payAmount" column="pay_amount"/>
        <result property="totalRegUCnt" column="total_reg_ucnt"/>
        <result property="totalPayUCnt" column="total_pay_ucnt"/>
    </resultMap>

    <select id="find" resultMap="VipRegChannelStatSumMap" parameterType="map">
        select * from
        (
        select
        c.chid as channel_id,
        c.chname as channel_name,
        sum(t.pv_cnt) as pv_cnt,
        sum(t.uv_cnt) as uv_cnt,
        sum(t.ip_cnt) as ip_cnt,
        sum(t.reg_ucnt) as reg_ucnt,
        sum(t.pay_ucnt) as pay_ucnt,
        sum(t.pay_first_amount) as pay_first_amount,
        sum(t.pay_amount) as pay_amount
        from tbl_vip_reg_channel_stat t
        join channel c
        on c.chid = t.channel_id
        where 1=1
        <if test="dateStart != null and dateStart != ''">and date_format(t.stat_date,'%Y-%m-%d') &gt;= #{dateStart}</if>
        <if test="dateEnd != null and dateEnd != ''">and date_format(t.stat_date,'%Y-%m-%d') &lt;= #{dateEnd}</if>
        <if test="channel != null and channel != ''">and c.chid like '%'||#{channel}||'%' or c.chname like
            '%'||#{channel}||'%'
        </if>
        <if test="countryId != null and countryId != ''">and t.country = #{countryId}</if>
        group by c.chid,c.chname
        <trim prefix="having" prefixOverrides="and">
            <if test="payAmountStart != null and payAmountStart !='' ">
                and sum(pay_amount) &gt;= #{payAmountStart}
            </if>
            <if test="payAmountEnd != null and payAmountEnd !='' ">
                and sum(pay_amount) &lt;= #{payAmountEnd}
            </if>
        </trim>
        <if test="1 == order and orderField != null and orderField != ''">
            order by ${orderField} desc
        </if>
        <if test="2 == order and orderField != null and orderField != ''">
            order by ${orderField} asc
        </if>
        ) t left join
        (
        select
        sum(t.reg_ucnt) as total_reg_ucnt,
        sum(t.pay_ucnt) as total_pay_ucnt
        from tbl_vip_reg_channel_stat t
        join channel c
        on c.chid = t.channel_id
        where 1=1
        <if test="dateStart != null and dateStart != ''">and date_format(t.stat_date,'%Y-%m-%d') &gt;= #{dateStart}</if>
        <if test="dateEnd != null and dateEnd != ''">and date_format(t.stat_date,'%Y-%m-%d') &lt;= #{dateEnd}</if>
        <if test="channel != null and channel != ''">and c.chid like '%'||#{channel}||'%' or c.chname like
            '%'||#{channel}||'%'
        </if>
        <if test="countryId != null and countryId != ''">and t.country = #{countryId}</if>
        ) t1 on 1 = 1

    </select>
</mapper>