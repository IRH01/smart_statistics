<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="gameUserChnl">

    <resultMap type="GameUserChnl" id="GameUserChnlMap" extends="lossDaily.LossDailyMap">
        <result property="statDate" column="stat_date"/>
        <result property="channelId" column="channel_id"/>
        <result property="platformId" column="platform_id"/>
        <result property="regUcnt" column="reg_ucnt"/>
        <result property="rechargeUcnt" column="recharge_ucnt"/>
        <result property="rechargeAmount" column="recharge_amount"/>
        <result property="activeUcnt" column="active_ucnt"/>
        <result property="totalActiveUcnt" column="total_active_ucnt"/>
        <result property="activeRate" column="active_rate"/>
        <result property="osName" column="os_name"/>
        <result property="produceId" column="produce_id"/>
        <result property="produceName" column="produce_name"/>
    </resultMap>

    <select id="findD" resultMap="GameUserChnlMap" parameterType="map">
        SELECT
        DATE_FORMAT(t1.stat_date,'%Y-%m-%d') AS stat_date,
        CASE WHEN t1.channel_id = '-1' THEN '全部' ELSE t1.channel_id END AS channel_id,
        CASE WHEN t1.platform_id = '-1' THEN '全部' ELSE t2.name END AS platform_id,
        reg_ucnt,
        recharge_ucnt,
        CASE WHEN t1.platform_id = '-1' THEN '全部' WHEN t2.type = 1 THEN 'PC' WHEN t2.type = 2 THEN '安卓' WHEN t2.type = 3
        THEN 'ios' WHEN t2.type = 4 THEN 'h5' WHEN t2.type = 5 THEN '其他' END AS os_name,
        FORMAT(t1.recharge_amount,2) AS recharge_amount,
        active_ucnt,
        t1.total_active_ucnt,
        FORMAT(t1.active_rate * 100,2) AS active_rate
        FROM
        view_inner_game_chnl_opt_day t1 LEFT JOIN (SELECT * FROM gp_tbl_platform_info t WHERE t.type = 1 AND t.country
        =0 AND t.is_oneself = 0) t2 ON t1.platform_id = t2.id
        WHERE 1 = 1
        <if test="channelId != null and channelId != ''">and channel_id = #{channelId}</if>
        <if test="platformId != null and platformId != ''">and platform_id = #{platformId}</if>
        <if test="dateStart != null and dateStart != ''">and date_format(stat_date,'%Y-%m-%d') &gt;= #{dateStart}</if>
        <if test="dateEnd != null and dateEnd != ''">and date_format(stat_date,'%Y-%m-%d') &lt; #{dateEnd}</if>
        order by stat_date desc
    </select>

    <select id="findH" resultMap="GameUserChnlMap" parameterType="map">
        select
        date_format(t1.stat_date,'%Y-%m-%d %H:%i:%s') as stat_date,
        case when t1.channel_id = '-1' then '全部' else t1.channel_id end as channel_id,
        case when t1.platform_id = '-1' then '全部' else t2.name end as platform_id,
        reg_ucnt,
        recharge_ucnt,
        case when t1.platform_id = '-1' then '全部'
        when t2.type = 1 then 'PC'
        when t2.type = 2 then '安卓'
        when t2.type = 3 then 'IOS'
        when t2.type = 4 then 'H5'
        when t2.type = 5 then '其他' end as os_name,
        FORMAT(t1.recharge_amount,2) as recharge_amount,
        active_ucnt,
        t1.total_active_ucnt,
        FORMAT(t1.active_rate * 100,2) as active_rate
        from
        view_inner_game_chnl_opt_h t1 left join (select * from gp_tbl_platform_info t where t.type = 1 and t.country =0
        and t.is_oneself = 0) t2 on t1.platform_id = t2.id

        where 1 = 1
        <if test="channelId != null and channelId != ''">and channel_id = #{channelId}</if>
        <if test="platformId != null and platformId != ''">and platform_id = #{platformId}</if>
        <if test="dateStart != null and dateStart != ''">and date_format(stat_date,'%Y-%m-%d') &gt;= #{dateStart}</if>
        <if test="dateEnd != null and dateEnd != ''">and date_format(stat_date,'%Y-%m-%d') &lt;= #{dateEnd}</if>
        order by stat_date desc
    </select>

    <select id="countD" resultType="int" parameterType="map">
        select
        count(1)
        from
        view_inner_game_chnl_opt_day t1 left join (select * from gp_tbl_platform_info t where t.type = 1 and t.country
        =0 and t.is_oneself = 0) t2 on t1.platform_id = t2.id
        where 1 = 1
        <if test="channelId != null and channelId != ''">and channel_id = #{channelId}</if>
        <if test="platformId != null and platformId != ''">and platform_id = #{platformId}</if>
        <if test="dateStart != null and dateStart != ''">and date_format(stat_date,'%Y-%m-%d') &gt;= #{dateStart}</if>
        <if test="dateEnd != null and dateEnd != ''">and date_format(stat_date,'%Y-%m-%d') &lt; #{dateEnd}</if>
        order by stat_date desc
    </select>

    <select id="countH" resultType="int" parameterType="map">
        select
        count(1)
        from
        view_inner_game_chnl_opt_h t1 left join (select * from gp_tbl_platform_info t where t.type = 1 and t.country =0
        and t.is_oneself = 0) t2 on t1.platform_id = t2.id

        where 1 = 1
        <if test="channelId != null and channelId != ''">and channel_id = #{channelId}</if>
        <if test="platformId != null and platformId != ''">and platform_id = #{platformId}</if>
        <if test="dateStart != null and dateStart != ''">and date_format(stat_date,'%Y-%m-%d') &gt;= #{dateStart}</if>
        <if test="dateEnd != null and dateEnd != ''">and date_format(stat_date,'%Y-%m-%d') &lt;= #{dateEnd}</if>
        order by stat_date desc
    </select>

    <select id="getProduces" resultMap="GameUserChnlMap" parameterType="map">
        select id as produce_id , name as produce_name from gp_tbl_platform_info t where t.type = 1 and t.country =0 and
        t.is_oneself = 0
    </select>
</mapper>