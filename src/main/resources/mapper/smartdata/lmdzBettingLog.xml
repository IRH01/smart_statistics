<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="lmdzBettingLog">
	<resultMap type="LmdzBettingLog" id="LmdzBettingLogMap">
		<result property="settleTime" column="settle_time"/>
		<result property="userId" column="user_id"/>
		<result property="platformId" column="platform_id"/>
		<result property="bureauNo" column="bureauno"/>
		<result property="roomNo" column="roomno"/>
		<result property="gameType" column="game_type"/>
		<result property="incomeAmount" column="income_amount"/>
		<result property="betAmount" column="bet_amount"/>
		<result property="boardResult" column="board_result"/>
		<result property="cardType" column="card_type"/>
		<result property="card" column="card"/>
	</resultMap>
	
	<select id="find" resultMap="LmdzBettingLogMap" parameterType="map">
		select
			lb.settle_time,
			lb.user_id,
			lb.platform_id,
			lb.bureauno,
			lb.roomno,
			lb.game_type,
			lb.income_amount,
			lb.bet_amount,
			lb.board_result,
			lb.card_type,
			lb.card
		from tbl_ods_lmdz_betting_log lb
		where 1=1
			and exists(
				select qm.user_id 
				from tbl_dw_member_qual_list_mon qm
				where qm.partner_user_id = #{partnerUserId}  
				and date_format(qm.month_id,'%Y-%m') = #{monthId}
				and qm.game_type_id= #{gameTypeId}
				and qm.user_id =  lb.user_id
			)
			and exists(
				select gt.game_id
				from tbl_dim_game_type_con gt
				where gt.game_type_id = #{gameTypeId}  
				and gt.game_id =  lb.platform_id
			)
			<if test="dateStart != null and dateStart != ''">and date_format( lb.settle_time,'%Y-%m-%d') &gt;= #{dateStart} </if>
			<if test="dateEnd != null and dateEnd != ''">and date_format( lb.settle_time,'%Y-%m-%d') &lt;= #{dateEnd} </if>
		order by  lb.settle_time desc
	</select>
	
	<select id="count" resultType="int" parameterType="map">
		select 
			count(*) count
		from tbl_ods_lmdz_betting_log lb
		where 1=1
			and exists(
				select qm.user_id 
				from tbl_dw_member_qual_list_mon qm
				where qm.partner_user_id = #{partnerUserId}  
				and date_format(qm.month_id,'%Y-%m') = #{monthId}
				and qm.game_type_id= #{gameTypeId}
				and qm.user_id =  lb.user_id
			)
			and exists(
				select gt.game_id
				from tbl_dim_game_type_con gt
				where gt.game_type_id = #{gameTypeId}  
				and gt.game_id =  lb.platform_id
			)
			<if test="dateStart != null and dateStart != ''">and date_format( lb.settle_time,'%Y-%m-%d') &gt;= #{dateStart} </if>
			<if test="dateEnd != null and dateEnd != ''">and date_format( lb.settle_time,'%Y-%m-%d') &lt;= #{dateEnd} </if>
	</select>
</mapper>