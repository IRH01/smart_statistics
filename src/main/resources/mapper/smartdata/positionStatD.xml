<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="positionStatD">

    <resultMap type="com.hhly.smartdata.dto.PositionStatDShower"
               id="positionStatDMapper">
        <result column="position_id" property="positionId"></result>
        <result column="click_cnt" property="clickCnt"></result>
        <result column="stay_cnt" property="stayCnt"></result>
        <result column="ip_cnt" property="ipCnt"></result>
        <result column="info_cnt" property="infoCnt"></result>
        <result column="positionName" property="positionName"></result>
    </resultMap>


    <select id="findPositionStatD" resultMap="positionStatDMapper"
            parameterType="map">
        select
        d.position_id,d.click_cnt,d.stay_cnt,d.ip_cnt,d.info_cnt,GETALLPOSNAME(d.position_id) position_name
        from tbl_dm_add_position_stat_d d
        join tbl_dw_dim_position p on (d.position_id = p.tbl_id)

        where 1= 1
        <if test="domain != null">
            and d.domain_id = #{domain}
        </if>
        <if test="date != null">
            and date_format(d.etl_date,'%Y-%m-%d') = #{date}
        </if>
        <if test="positionIdArr!= null">
            and d.position_id in
            <foreach item="item" index="index" collection="positionIdArr"
                     open="(" separator="," close=")">
                #{item}
            </foreach>
        </if>
        order by position_name asc
    </select>

    <resultMap type="com.hhly.smartdata.dto.PositionCountByDay" id="countByDayMapper">
        <result column="current_date" property="date"></result>
        <result column="click_cnt_total" property="clickCntTotal"></result>
        <result column="ip_cnt_total" property="ipCntTotal"></result>
        <result column="stay_cnt_total" property="stayCntTotal"></result>
    </resultMap>

    <select id="countByDay" parameterType="map" resultMap="countByDayMapper">
        select
        date_format(d.etl_date,'%Y-%m-%d') as current_date,sum(click_cnt) as click_cnt_total,sum(ip_cnt) as
        ip_cnt_total, sum(stay_cnt) as stay_cnt_total
        from tbl_dm_add_position_stat_d d

        where 1= 1
        <if test="domain != null">
            and d.domain_id = #{domain}
        </if>
        <if test="date != null">
            and date_format(d.etl_date,'%Y-%m-%d') = #{date}
        </if>
        <if test="positionIdArr!= null">
            and d.position_id in
            <foreach item="item" index="index" collection="positionIdArr"
                     open="(" separator="," close=")">
                #{item}
            </foreach>
        </if>
        group by date_format(d.etl_date,'%Y-%m-%d')
    </select>

</mapper>